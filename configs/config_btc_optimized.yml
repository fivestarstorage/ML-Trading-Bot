data:
  source: alpaca
  folder: Data
  symbol: BTC
  timeframe_base: 5m
  alpaca:
    asset_class: crypto
    exchange: us
    start: "2020-01-01"
    end: "2025-11-26"
    limit: 10000

timeframes:
  h4: 240
  h1: 60
  m30: 30

strategy:
  strategy_type: crypto_momo
  
  # === CRITICAL: CONSERVATIVE RISK SETTINGS ===
  # With 5% max DD target, risk per trade must be ~1% or less
  risk_percent: 1.2           # 1.2% risk per trade (allows 4+ losses before 5% DD)
  risk_percent_low_vol: 0.6   # 0.6% during low volatility
  
  # Higher Timeframe Filters - TIGHTER
  use_daily_trend_filter: true
  allow_daily_range_trades: false  # DISABLED - only trade with trend
  daily_trend_fast: 50
  daily_trend_slow: 200
  daily_trend_range_threshold: 0.12  # Tighter range threshold
  require_killzone_filter: true  # ENABLED - only trade best sessions
  session_filter:
    - london
    - new_york
  killzones:
    asia:
      start: "00:00"
      end: "03:00"
    london:
      start: "07:00"
      end: "11:00"
    new_york:
      start: "13:00"
      end: "17:00"

  # ORB Parameters
  orb_bars: 12
  orb_start_hour: 13
  orb_start_minute: 30
  orb_end_hour: 14
  orb_end_minute: 30
  only_trade_after_14utc: false
  require_atr_expansion: true  # ENABLED - only trade during volatility
  momentum_period: 5
  min_momentum: 0.002  # Require momentum confirmation
  max_trades_per_day: 3  # DOWN from 5 - quality over quantity
  
  # === IMPROVED TP/SL RATIOS FOR HIGHER WIN RATE ===
  atr_period: 14
  tp_atr_mult: 1.8    # Slightly lower TP for higher hit rate
  sl_atr_mult: 1.2    # Tighter SL for less damage
  label_window: 200
  
  # === AGGRESSIVE TRAILING STOP FOR PROFIT PROTECTION ===
  use_trailing_stop: true
  trailing_stop_atr: 0.8   # Tighter trailing (was 1.0)
  trailing_start_profit: 0.8  # Start trailing earlier at 0.8R (was 1.0)
  
  # Break-even - EARLIER
  breakeven_trigger_r: 1.0  # Move to BE at 1R (was 1.5)
  
  # Partial Closes - MORE AGGRESSIVE PROFIT TAKING
  partial_close_15r: 0.30   # Close 30% at 1.5R (was 20%)
  partial_close_2r: 0.30    # Close 30% at 2R (was 20%)
  
  # === STRICTER ML FILTER FOR HIGHER WIN RATE ===
  model_threshold: 0.62     # UP from 0.55 - only take high-confidence trades
  entry_type_filter: both
  
  # SMC parameters (compatibility)
  h4_swing_lookback: 60
  inducement_lookback: 6
  fvg_lookback: 10
  ob_lookback: 20
  require_discount_premium: false
  require_inducement: false
  require_rsi_filter: true   # ENABLED
  require_adx_filter: true   # ENABLED
  require_bull_only: false
  require_liquidity_sweep: false
  liquidity_sweep_lookback: 18
  liquidity_sweep_tolerance: 0.0015
  require_displacement: true
  displacement_min_atr: 1.0  # UP from 0.9 - require strong moves
  low_vol_ratio: 0.75        # UP from 0.7 - avoid choppy markets
  min_volume_zscore: -1.5    # Tightened from -2.0

  # Trend scaffolding
  trend_fast_period: 21
  trend_slow_period: 55

  # === CRYPTO-SPECIFIC OPTIMIZED PARAMETERS ===
  crypto:
    breakout_lookback: 36      # Same as original
    breakout_buffer_pct: 0.0   # Same as original
    min_breakout_range_atr: 0.2 # Same as original
    max_breakout_range_atr: 10.0  # Same as original
    min_adx: 15                  # Same as original
    min_rsi_long: 52             # Same as original
    max_rsi_long: 85             # Same as original
    max_rsi_short: 44            # Same as original
    min_rsi_short: 18            # Same as original
    min_atr_ratio: 0.6           # Same as original
    min_volume_zscore: -2.0      # Same as original
    min_trend_gap_atr: 0.1       # Same as original
    max_distance_atr: 3.0        # Same as original
    min_distance_atr: -2.0       # Same as original
    reversion_rsi_min_long: 32   # Same as original
    reversion_rsi_max_long: 58   # Same as original
    reversion_rsi_min_short: 42  # Same as original
    reversion_rsi_max_short: 70  # Same as original
    enable_long: true
    enable_short: true
    
    # === KEY CHANGE: BETTER R:R FOR HIGHER WIN RATE ===
    tp_atr_mult: 1.3           # DOWN from 1.5 - smaller TP for higher hit rate
    sl_atr_mult: 0.9           # Slightly tighter SL
    label_window: 140          # Same as original
    
    # === SAME FILTERS AS ORIGINAL (for more candidates) ===
    min_volume_pressure: 0.85    # Same as original
    min_mom_composite: 0.002     # Same as original
    min_volatility_ratio: 0.7    # Same as original
    max_bb_width: 0.3            # Same as original
    max_range_contraction: 9.0   # Same as original
    min_trend_persistence: -0.2  # Same as original
    killzone_bias_only: false    # Same as original
    killzone_labels: ["london", "new_york"]
    min_liquidity_imbalance: 0.12  # Same as original
    
    momentum_minutes:
      fast: 45
      mid: 240
      slow: 720
    volume_minutes:
      short: 180
      long: 1440
    volatility_minutes:
      short: 120
      long: 720
    compression_minutes: 720
    
    # === REGIME-AWARE TARGETS (more conservative) ===
    regime_tp_multipliers:
      trend: 2.2        # DOWN from 2.8
      compression: 1.6  # DOWN from 1.9
      mean_revert: 1.0  # DOWN from 1.1
      neutral: 1.2      # DOWN from 1.4
    regime_sl_multipliers:
      trend: 1.0        # DOWN from 1.1
      compression: 0.9  # UP from 0.85
      mean_revert: 0.85 # UP from 0.8
      neutral: 0.95     # UP from 0.9
    
    meta_feature_columns:
      - mom_composite
      - mom_imbalance
      - volume_pressure
      - volume_acceleration
      - volatility_ratio_fast
      - trend_regime_code
      - trend_persistence
      - bb_width
      - bb_zscore
      - keltner_distance
      - vwap_distance
      - return_1h
      - return_4h
      - return_1d
      - micro_trend
      - price_acceleration
      - hour_sin
      - hour_cos
      - volume_zscore
      - atr_ratio
      - liquidity_imbalance

ml:
  model_path: models/lgbm_model.pkl
  features_path: data/features.parquet
  
  lgbm:
    objective: binary
    boosting_type: gbdt
    n_estimators: 2500      # UP from 2000
    learning_rate: 0.008    # DOWN from 0.01 - smoother learning
    num_leaves: 12          # DOWN from 15 - simpler model
    max_depth: 4            # DOWN from 5 - less overfitting
    min_child_samples: 70   # UP from 50 - more robust
    subsample: 0.65         # DOWN from 0.7
    colsample_bytree: 0.65  # DOWN from 0.7
    reg_alpha: 0.2          # UP from 0.1
    reg_lambda: 3.0         # UP from 2.0
    early_stopping_rounds: 150  # UP from 100
    verbose: -1
    min_data_in_leaf: 70    # UP from 50
    
  scale_pos_weight_mode: balanced

backtest:
  commission: 0.0004
  slippage: 0.5
  mode: propfirm
  
  propfirm:
    initial_capital: 6000
    max_drawdown_pct: 0.05   # CRITICAL: 5% max DD
    per_trade_risk_pct: 0.012  # 1.2% max risk per trade
    payout_cycle_days: 14
    
  # === ADVANCED RISK CONTROLS ===
  risk_controls:
    max_daily_loss_pct: 0.015     # Max 1.5% loss per day (ensures 3+ losses to hit daily limit)
    max_consecutive_losses: 4     # Stop after 4 consecutive losses
    cool_down_hours: 6            # Wait 6h after max losses
    max_weekly_drawdown_pct: 0.035 # Max 3.5% weekly drawdown
    volatility_scaling: true      # Scale position by volatility
    correlation_filter: true      # Avoid correlated trades

wfa:
  train_years: 4
  test_months: 6
  slide_months: 1
  min_train_samples: 80  # Reduced for crypto (fewer signals)

adaptive:
  enabled: false  # DISABLED - use fixed risk settings
  threshold_grid: [0.55, 0.58, 0.60, 0.62, 0.65, 0.68, 0.70, 0.72]
  min_trades_per_fold: 8
  min_fold_win_rate: 0.60
  skip_negative_months: true
  risk_step: 0.001
  risk_bounds:
    min: 0.008    # 0.8% min risk
    max: 0.015    # 1.5% max risk - CRITICAL for 5% max DD
  state_path: btc_optimized_adaptive_state.json  # Separate state file
  session_guard:
    enabled: true
    win_rate_threshold: 0.55
    min_samples: 15
  filter_profiles:
    strict_killzone:
      description: "London/NY killzone only, require sweep + strong displacement"
      session_labels: ["london", "new_york"]
      require_killzone: true
      require_liquidity_sweep: true
      min_displacement: 1.2
    balanced_core:
      description: "Default high-probability flow during London/NY"
      session_labels: ["london", "new_york"]
      require_killzone: true
      min_displacement: 1.0
    quality_only:
      description: "Highest quality setups only"
      session_labels: ["london", "new_york"]
      require_killzone: true
      min_displacement: 1.3
      require_adx: true

live_trading:
  enabled: false
  use_demo: true
  epic: "BTC/USD"
  order_type: "MARKET"
  size: 1.0
  currency_code: "USD"
  expiry: "DFB"
  force_open: true
  guaranteed_stop: false
  probability_threshold: 0.65
  max_history_bars: 2000
  min_history_bars: 300

